{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "description": "Azure Web App for Baby Maker 5000 - Python/Streamlit application"
    },
    "parameters": {
        "webAppName": {
            "type": "string",
            "defaultValue": "[concat('babymaker-app-', uniqueString(resourceGroup().id))]",
            "metadata": {
                "description": "Name of the Web App"
            }
        },
        "appServicePlanId": {
            "type": "string",
            "metadata": {
                "description": "Resource ID of the App Service Plan"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for the Web App"
            }
        },
        "pythonVersion": {
            "type": "string",
            "defaultValue": "3.12",
            "allowedValues": [
                "3.9",
                "3.10",
                "3.11",
                "3.12"
            ],
            "metadata": {
                "description": "Python version for the application"
            }
        },
        "replicateApiToken": {
            "type": "securestring",
            "metadata": {
                "description": "Replicate API token for AI image generation"
            }
        },
        "azureStorageConnectionString": {
            "type": "securestring",
            "metadata": {
                "description": "Azure Storage connection string for blob storage"
            }
        },
        "enableApplicationInsights": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "Enable Application Insights for monitoring"
            }
        }
    },
    "variables": {
        "webAppName": "[toLower(parameters('webAppName'))]",
        "applicationInsightsName": "[concat(variables('webAppName'), '-insights')]"
    },
    "resources": [
        {
            "condition": "[parameters('enableApplicationInsights')]",
            "type": "Microsoft.Insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('applicationInsightsName')]",
            "location": "[parameters('location')]",
            "tags": {
                "Application": "Baby Maker 5000",
                "Environment": "Production",
                "Purpose": "Application Monitoring"
            },
            "kind": "web",
            "properties": {
                "Application_Type": "web",
                "Request_Source": "rest"
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2023-01-01",
            "name": "[variables('webAppName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
            ],
            "tags": {
                "Application": "Baby Maker 5000",
                "Environment": "Production",
                "Purpose": "Streamlit Web App",
                "Framework": "Python"
            },
            "kind": "app,linux",
            "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "reserved": true,
                "httpsOnly": true,
                "clientAffinityEnabled": false,
                "siteConfig": {
                    "linuxFxVersion": "[concat('PYTHON|', parameters('pythonVersion'))]",
                    "alwaysOn": true,
                    "ftpsState": "Disabled",
                    "minTlsVersion": "1.2",
                    "scmMinTlsVersion": "1.2",
                    "use32BitWorkerProcess": false,
                    "webSocketsEnabled": true,
                    "managedPipelineMode": "Integrated",
                    "virtualApplications": [
                        {
                            "virtualPath": "/",
                            "physicalPath": "site\\wwwroot",
                            "preloadEnabled": true
                        }
                    ],
                    "defaultDocuments": [
                        "app.py"
                    ],
                    "appSettings": [
                        {
                            "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                            "value": "true"
                        },
                        {
                            "name": "ENABLE_ORYX_BUILD",
                            "value": "true"
                        },
                        {
                            "name": "PRE_BUILD_COMMAND",
                            "value": "echo 'Installing dependencies...'"
                        },
                        {
                            "name": "POST_BUILD_COMMAND",
                            "value": "echo 'Build complete'"
                        },
                        {
                            "name": "PYTHONPATH",
                            "value": "/home/site/wwwroot"
                        },
                        {
                            "name": "WEBSITE_RUN_FROM_PACKAGE",
                            "value": "0"
                        },
                        {
                            "name": "REPLICATE_API_TOKEN",
                            "value": "[parameters('replicateApiToken')]"
                        },
                        {
                            "name": "AZURE_STORAGE_CONNECTION_STRING",
                            "value": "[parameters('azureStorageConnectionString')]"
                        },
                        {
                            "name": "STREAMLIT_SERVER_PORT",
                            "value": "8000"
                        },
                        {
                            "name": "STREAMLIT_SERVER_ADDRESS",
                            "value": "0.0.0.0"
                        },
                        {
                            "name": "STREAMLIT_BROWSER_GATHER_USAGE_STATS",
                            "value": "false"
                        },
                        {
                            "name": "STREAMLIT_SERVER_HEADLESS",
                            "value": "true"
                        },
                        {
                            "name": "STREAMLIT_SERVER_ENABLE_CORS",
                            "value": "false"
                        },
                        {
                            "name": "STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION",
                            "value": "false"
                        }
                    ]
                }
            }
        },
        {
            "condition": "[parameters('enableApplicationInsights')]",
            "type": "Microsoft.Web/sites/config",
            "apiVersion": "2023-01-01",
            "name": "[concat(variables('webAppName'), '/appsettings')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('webAppName'))]",
                "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
            ],
            "properties": {
                "APPINSIGHTS_INSTRUMENTATIONKEY": "[if(parameters('enableApplicationInsights'), reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))).InstrumentationKey, '')]",
                "APPLICATIONINSIGHTS_CONNECTION_STRING": "[if(parameters('enableApplicationInsights'), reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))).ConnectionString, '')]",
                "ApplicationInsightsAgent_EXTENSION_VERSION": "~3"
            }
        }
    ],
    "outputs": {
        "webAppName": {
            "type": "string",
            "value": "[variables('webAppName')]"
        },
        "webAppUrl": {
            "type": "string",
            "value": "[concat('https://', variables('webAppName'), '.azurewebsites.net')]"
        },
        "webAppId": {
            "type": "string",
            "value": "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
        },
        "applicationInsightsName": {
            "type": "string",
            "value": "[if(parameters('enableApplicationInsights'), variables('applicationInsightsName'), '')]"
        },
        "applicationInsightsInstrumentationKey": {
            "type": "string",
            "value": "[if(parameters('enableApplicationInsights'), reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))).InstrumentationKey, '')]"
        }
    }
} 